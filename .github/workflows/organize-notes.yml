name: Move and Organize Content
on:
  push:
    paths:
      - 'website/**'
  workflow_dispatch:

jobs:
  process-content:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm install
        
      - name: Setup content structure
        run: |
          mkdir -p website/{Articles,"Book Notes","Second Brain"}
          find website/Articles -type f ! -name "index.md" -delete || true
          find website/"Book Notes" -type f ! -name "index.md" -delete || true
          find website/"Second Brain" -type f ! -name "index.md" -delete || true

      - name: Create and run organization script
        run: |
          # Create the script
          echo '#!/bin/bash

          process_file() {
              local file="$1"
              local base_dir="website/content"
              
              # Skip non-markdown files and index files
              if [[ ! "$file" =~ \.md$ ]] || [[ "$(basename "$file")" == "index.md" ]]; then
                  return
              fi
              
              # Read the YAML front matter and check tags
              if grep -qP '"'"'(?s)^---.*?tag:\s*.*\bbook\b.*?---'"'"' "$file"; then
                  destination="${base_dir}/Book Notes/$(basename "$file")"
                  echo "Moving $(basename "$file") to Book Notes"
              elif grep -qP '"'"'(?s)^---.*?tag:\s*.*\barticle\b.*?---'"'"' "$file"; then
                  destination="${base_dir}/Articles/$(basename "$file")"
                  echo "Moving $(basename "$file") to Articles"
              else
                  destination="${base_dir}/Second Brain/$(basename "$file")"
                  echo "Moving $(basename "$file") to Second Brain"
              fi
              
              # Move the file
              cp "$file" "$destination"
          }

          # Process all markdown files
          find website -type f -name "*.md" | while read -r file; do
              process_file "$file"
          done

          # Print summary
          echo "=== Organization Summary ==="
          echo "Articles: $(find website/content/Articles -type f ! -name "index.md" | wc -l) files"
          echo "Book Notes: $(find website/content/Book Notes -type f ! -name "index.md" | wc -l) files"
          echo "Second Brain: $(find website/content/Second Brain -type f ! -name "index.md" | wc -l) files"
          ' > organize-notes.sh

          # Make the script executable
          chmod +x organize-notes.sh
          
          # Run the script
          ./organize-notes.sh

      - name: Move files to website/content
        run: |
          cp -r website/* content/ || true
          
      - name: List contents for verification
        run: |
          echo "=== Content Directory Structure ==="
          find website/content -type f -name "*.md" | sort

      - name: Commit and push changes
        run: |
          git config user.name "aneurokumar"
          git config user.email "aneurokumar@gmail.com"
          git fetch origin v4
          git checkout v4
          git merge origin/v4 --no-edit
          git add -A website/content/
          git commit -m "Move and organize content files" || true
          git push origin v4

      - name: Deploy with Quartz
        run: npx quartz sync
